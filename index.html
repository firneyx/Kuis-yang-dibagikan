import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut,
    signInAnonymously,
    signInWithCustomToken
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    addDoc, 
    doc, 
    setDoc, 
    getDoc, 
    getDocs, 
    updateDoc, 
    deleteDoc, 
    query, 
    where, 
    onSnapshot,
    serverTimestamp,
    arrayUnion,
    arrayRemove
} from 'firebase/firestore';
import { setLogLevel } from 'firebase/firestore';

// --- SVG Icons ---
const TrashIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
    </svg>
);
const EditIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
        <path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" />
    </svg>
);
const PlusIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
    </svg>
);
const PlayIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
    </svg>
);

// --- Firebase Initialization ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

let app;
let auth;
let db;

try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    // setLogLevel('debug'); // Uncomment for detailed logs
} catch (e) {
    console.error("Firebase initialization failed:", e);
}


// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [page, setPage] = useState('home'); // home, dashboard, createQuiz, editQuiz, hostLobby, game, results, join, playerLobby, playerGame, playerResult
    const [quizIdToEdit, setQuizIdToEdit] = useState(null);
    const [gameCode, setGameCode] = useState('');
    const [nickname, setNickname] = useState('');
    const [sessionData, setSessionData] = useState(null);
    const [error, setError] = useState('');

    useEffect(() => {
        if (!auth) return;
        const authInit = async () => {
            try {
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error signing in:", error);
                setError("Gagal melakukan otentikasi. Silakan coba lagi.");
            }
        };

        authInit();

        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser && !currentUser.isAnonymous ? currentUser : null);
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    const navigate = (pageName) => {
        setError('');
        setPage(pageName);
    };

    const handleJoinQuiz = async (code, name) => {
        if (!code || !name) {
            setError("Kode permainan dan nama panggilan harus diisi.");
            return;
        }
        try {
            const sessionsRef = collection(db, `artifacts/${appId}/public/data/gameSessions`);
            const q = query(sessionsRef, where("gameCode", "==", code), where("status", "==", "lobby"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                setError("Kuis tidak ditemukan atau sudah dimulai. Periksa kembali kode Anda.");
                return;
            }

            const sessionDoc = querySnapshot.docs[0];
            const sessionId = sessionDoc.id;
            const participant = { id: crypto.randomUUID(), name, score: 0 };
            
            await updateDoc(doc(db, `artifacts/${appId}/public/data/gameSessions`, sessionId), {
                participants: arrayUnion(participant)
            });
            
            setGameCode(code);
            setNickname(name);
            navigate('playerLobby');

        } catch (err) {
            console.error("Error joining quiz:", err);
            setError("Gagal bergabung dengan kuis. Silakan coba lagi.");
        }
    };

    const renderPage = () => {
        switch (page) {
            case 'dashboard': return <Dashboard navigate={navigate} setQuizIdToEdit={setQuizIdToEdit} setGameCode={setGameCode} />;
            case 'createQuiz': return <QuizBuilder navigate={navigate} />;
            case 'editQuiz': return <QuizBuilder navigate={navigate} quizId={quizIdToEdit} />;
            case 'hostLobby': return <HostLobby navigate={navigate} gameCode={gameCode} setSessionData={setSessionData} />;
            case 'game': return <GameHostView navigate={navigate} sessionData={sessionData} />;
            case 'results': return <ResultsHostView navigate={navigate} sessionData={sessionData} />;
            case 'join': return <JoinScreen onJoin={handleJoinQuiz} error={error} setError={setError} />;
            case 'playerLobby': return <PlayerLobby navigate={navigate} gameCode={gameCode} nickname={nickname} />;
            case 'playerGame': return <PlayerGameView navigate={navigate} gameCode={gameCode} nickname={nickname} />;
            case 'playerResult': return <PlayerResultView navigate={navigate} gameCode={gameCode} nickname={nickname} />;
            default: return <HomeScreen navigate={navigate} user={user} loading={loading} />;
        }
    };

    return (
        <div className="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans">
            <Navbar user={user} navigate={navigate} />
            <main className="p-4 sm:p-6 md:p-8">
                {renderPage()}
            </main>
        </div>
    );
}

// --- Components ---

function Navbar({ user, navigate }) {
    const handleSignOut = async () => {
        try {
            await signOut(auth);
            navigate('home');
        } catch (error) {
            console.error("Error signing out:", error);
        }
    };

    return (
        <nav className="bg-white dark:bg-gray-800 shadow-md">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex items-center justify-between h-16">
                    <div className="flex-shrink-0">
                        <span onClick={() => navigate(user ? 'dashboard' : 'home')} className="text-2xl font-bold text-indigo-600 dark:text-indigo-400 cursor-pointer">
                           Kuis Interaktif
                        </span>
                    </div>
                    <div className="flex items-center">
                        {user ? (
                            <>
                                <button onClick={() => navigate('dashboard')} className="text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">Dashboard</button>
                                <button onClick={handleSignOut} className="ml-4 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">Keluar</button>
                            </>
                        ) : (
                           <span className="text-sm text-gray-500">Masuk untuk membuat kuis</span>
                        )}
                    </div>
                </div>
            </div>
        </nav>
    );
}


function HomeScreen({ navigate, user, loading }) {
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (!email || !password) {
            setError('Email dan kata sandi harus diisi.');
            return;
        }
        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
            navigate('dashboard');
        } catch (err) {
            setError(err.message.includes('auth/invalid-credential') ? 'Email atau kata sandi salah.' : 'Terjadi kesalahan. Silakan coba lagi.');
            console.error(err);
        }
    };

    if (loading) {
        return <div className="text-center p-10">Memuat...</div>;
    }

    return (
        <div className="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-16 min-h-[calc(100vh-10rem)]">
            <div className="w-full md:w-1/2 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                <h2 className="text-3xl font-bold text-center mb-4 text-indigo-600 dark:text-indigo-400">Gabung Kuis</h2>
                <p className="text-center text-gray-600 dark:text-gray-400 mb-6">Masukkan kode permainan untuk mulai.</p>
                <JoinScreen onJoin={(code, name) => navigate('join', { code, name })} />
            </div>
            
            {!user && (
                <div className="w-full md:w-1/2 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                    <h2 className="text-3xl font-bold text-center mb-4 text-indigo-600 dark:text-indigo-400">{isLogin ? 'Masuk Pembuat Kuis' : 'Daftar Pembuat Kuis'}</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="mb-4">
                            <label className="block text-gray-700 dark:text-gray-300 mb-2" htmlFor="email">Email</label>
                            <input type="email" id="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        <div className="mb-6">
                             <label className="block text-gray-700 dark:text-gray-300 mb-2" htmlFor="password">Kata Sandi</label>
                            <input type="password" id="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                        <button type="submit" className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-300">{isLogin ? 'Masuk' : 'Daftar'}</button>
                    </form>
                    <button onClick={() => setIsLogin(!isLogin)} className="w-full mt-4 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
                        {isLogin ? 'Belum punya akun? Daftar di sini.' : 'Sudah punya akun? Masuk di sini.'}
                    </button>
                </div>
            )}
        </div>
    );
}

function JoinScreen({ onJoin }) {
    const [code, setCode] = useState('');
    const [name, setName] = useState('');
    const [error, setError] = useState('');

    const handleJoin = async () => {
        if (!code || !name) {
            setError("Kode dan nama panggilan harus diisi.");
            return;
        }
        setError('');
        try {
            const sessionsRef = collection(db, `artifacts/${appId}/public/data/gameSessions`);
            const q = query(sessionsRef, where("gameCode", "==", code), where("status", "==", "lobby"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                setError("Kuis tidak ditemukan atau sudah dimulai.");
                return;
            }

            const sessionDoc = querySnapshot.docs[0];
            const participant = { id: crypto.randomUUID(), name, score: 0 };
            
            await updateDoc(doc(db, `artifacts/${appId}/public/data/gameSessions`, sessionDoc.id), {
                participants: arrayUnion(participant)
            });

            onJoin(code, name);

        } catch (err) {
            console.error("Error joining quiz:", err);
            setError("Gagal bergabung dengan kuis.");
        }
    };

    return (
        <div className="space-y-4">
            <input 
                type="text" 
                placeholder="Kode Permainan" 
                value={code} 
                onChange={(e) => setCode(e.target.value.trim())}
                className="w-full px-4 py-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg"
            />
            <input 
                type="text" 
                placeholder="Nama Panggilan" 
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full px-4 py-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-lg"
            />
            {error && <p className="text-red-500 text-sm">{error}</p>}
            <button 
                onClick={handleJoin} 
                className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-300 font-bold text-lg"
            >
                Gabung
            </button>
        </div>
    );
}


function Dashboard({ navigate, setQuizIdToEdit, setGameCode }) {
    const [quizzes, setQuizzes] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!auth.currentUser) return;
        const q = query(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/quizzes`));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const quizzesData = [];
            querySnapshot.forEach((doc) => {
                quizzesData.push({ id: doc.id, ...doc.data() });
            });
            setQuizzes(quizzesData);
            setLoading(false);
        }, (error) => {
            console.error("Error fetching quizzes:", error);
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    const handleStartGame = async (quizId) => {
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        const session = {
            quizId: quizId,
            hostId: auth.currentUser.uid,
            gameCode: code,
            status: 'lobby', // lobby, in-progress, finished
            participants: [],
            currentQuestionIndex: 0,
            createdAt: serverTimestamp()
        };
        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/gameSessions`), session);
            setGameCode(code);
            navigate('hostLobby');
        } catch (error) {
            console.error("Error starting game session:", error);
        }
    };
    
    const handleDeleteQuiz = async (quizId) => {
        if (window.confirm("Apakah Anda yakin ingin menghapus kuis ini?")) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/quizzes`, quizId));
            } catch (error) {
                console.error("Error deleting quiz:", error);
            }
        }
    };

    if (loading) return <div className="text-center p-10">Memuat kuis Anda...</div>;

    return (
        <div className="max-w-7xl mx-auto">
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold">Dashboard Kuis Saya</h1>
                <button onClick={() => navigate('createQuiz')} className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center">
                    <PlusIcon /> <span className="ml-2">Buat Kuis Baru</span>
                </button>
            </div>
            {quizzes.length === 0 ? (
                <div className="text-center py-16 bg-white dark:bg-gray-800 rounded-lg shadow">
                    <h2 className="text-xl font-semibold">Anda belum membuat kuis.</h2>
                    <p className="text-gray-500 dark:text-gray-400 mt-2">Klik "Buat Kuis Baru" untuk memulai.</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {quizzes.map(quiz => (
                        <div key={quiz.id} className="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col">
                            <div className="p-6 flex-grow">
                                <h3 className="text-xl font-bold mb-2">{quiz.title}</h3>
                                <p className="text-gray-600 dark:text-gray-400 text-sm">{quiz.description}</p>
                                <p className="text-gray-500 dark:text-gray-500 text-xs mt-2">{quiz.questions?.length || 0} Pertanyaan</p>
                            </div>
                            <div className="bg-gray-50 dark:bg-gray-700 p-4 flex justify-between items-center">
                                <button onClick={() => handleStartGame(quiz.id)} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-semibold flex items-center">
                                    <PlayIcon /> Mulai
                                </button>
                                <div className="flex space-x-2">
                                     <button onClick={() => { setQuizIdToEdit(quiz.id); navigate('editQuiz'); }} className="text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                                        <EditIcon />
                                    </button>
                                    <button onClick={() => handleDeleteQuiz(quiz.id)} className="text-gray-500 hover:text-red-600 dark:hover:text-red-400 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                                        <TrashIcon />
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

function QuizBuilder({ navigate, quizId }) {
    const [title, setTitle] = useState('');
    const [description, setDescription] = useState('');
    const [questions, setQuestions] = useState([{ text: '', type: 'multiple-choice', options: ['', '', '', ''], correctAnswer: 0, timeLimit: 20 }]);
    
    useEffect(() => {
        if (quizId) {
            const fetchQuiz = async () => {
                const quizDoc = await getDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/quizzes`, quizId));
                if (quizDoc.exists()) {
                    const data = quizDoc.data();
                    setTitle(data.title);
                    setDescription(data.description);
                    setQuestions(data.questions);
                }
            };
            fetchQuiz();
        }
    }, [quizId]);

    const handleQuestionChange = (index, field, value) => {
        const newQuestions = [...questions];
        newQuestions[index][field] = value;
        setQuestions(newQuestions);
    };

    const handleOptionChange = (qIndex, oIndex, value) => {
        const newQuestions = [...questions];
        newQuestions[qIndex].options[oIndex] = value;
        setQuestions(newQuestions);
    };

    const addQuestion = () => {
        setQuestions([...questions, { text: '', type: 'multiple-choice', options: ['', '', '', ''], correctAnswer: 0, timeLimit: 20 }]);
    };
    
    const removeQuestion = (index) => {
        const newQuestions = questions.filter((_, i) => i !== index);
        setQuestions(newQuestions);
    };

    const handleSaveQuiz = async () => {
        const quizData = { title, description, questions, creatorId: auth.currentUser.uid };
        try {
            if (quizId) {
                await setDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/quizzes`, quizId), quizData);
            } else {
                await addDoc(collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/quizzes`), quizData);
            }
            navigate('dashboard');
        } catch (error) {
            console.error("Error saving quiz:", error);
        }
    };

    return (
        <div className="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
            <h2 className="text-3xl font-bold mb-6">{quizId ? 'Edit Kuis' : 'Buat Kuis Baru'}</h2>
            <div className="mb-6">
                <label className="block text-gray-700 dark:text-gray-300 mb-2 text-lg">Judul Kuis</label>
                <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" />
            </div>
            <div className="mb-8">
                <label className="block text-gray-700 dark:text-gray-300 mb-2 text-lg">Deskripsi</label>
                <textarea value={description} onChange={(e) => setDescription(e.target.value)} className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" rows="3"></textarea>
            </div>

            {questions.map((q, qIndex) => (
                <div key={qIndex} className="mb-8 p-6 border border-gray-200 dark:border-gray-700 rounded-lg relative">
                     <h3 className="text-xl font-semibold mb-4">Pertanyaan {qIndex + 1}</h3>
                     <button onClick={() => removeQuestion(qIndex)} className="absolute top-4 right-4 text-red-500 hover:text-red-700">
                        <TrashIcon />
                    </button>
                    <div className="mb-4">
                        <label className="block text-gray-700 dark:text-gray-300 mb-2">Teks Pertanyaan</label>
                        <input type="text" value={q.text} onChange={(e) => handleQuestionChange(qIndex, 'text', e.target.value)} className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" />
                    </div>
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {q.options.map((opt, oIndex) => (
                            <div key={oIndex} className="flex items-center">
                                <input type="radio" name={`correct-answer-${qIndex}`} checked={q.correctAnswer === oIndex} onChange={() => handleQuestionChange(qIndex, 'correctAnswer', oIndex)} className="mr-3 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                                <input type="text" value={opt} onChange={(e) => handleOptionChange(qIndex, oIndex, e.target.value)} placeholder={`Opsi ${oIndex + 1}`} className="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" />
                            </div>
                        ))}
                    </div>
                </div>
            ))}

            <div className="flex justify-between items-center mt-8">
                <button onClick={addQuestion} className="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-6 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Tambah Pertanyaan</button>
                <button onClick={handleSaveQuiz} className="bg-green-500 text-white px-8 py-3 rounded-lg hover:bg-green-600 transition font-bold">Simpan Kuis</button>
            </div>
        </div>
    );
}

function HostLobby({ navigate, gameCode, setSessionData }) {
    const [participants, setParticipants] = useState([]);
    const [sessionId, setSessionId] = useState(null);

    useEffect(() => {
        if (!gameCode) return;

        const sessionsRef = collection(db, `artifacts/${appId}/public/data/gameSessions`);
        const q = query(sessionsRef, where("gameCode", "==", gameCode));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            if (!querySnapshot.empty) {
                const sessionDoc = querySnapshot.docs[0];
                const data = sessionDoc.data();
                setSessionId(sessionDoc.id);
                setParticipants(data.participants || []);
                setSessionData(data);
            }
        });

        return () => unsubscribe();
    }, [gameCode, setSessionData]);

    const handleStartGame = async () => {
        if (sessionId) {
            await updateDoc(doc(db, `artifacts/${appId}/public/data/gameSessions`, sessionId), { status: 'in-progress' });
            navigate('game');
        }
    };

    return (
        <div className="text-center max-w-2xl mx-auto">
            <h1 className="text-4xl font-bold mb-4">Lobi Permainan</h1>
            <p className="text-lg text-gray-600 dark:text-gray-400 mb-6">Bagikan kode ini agar peserta bisa bergabung:</p>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-8 inline-block">
                <p className="text-6xl font-bold tracking-widest text-indigo-600 dark:text-indigo-400">{gameCode}</p>
            </div>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 className="text-2xl font-bold mb-4">Peserta ({participants.length})</h2>
                <div className="flex flex-wrap justify-center gap-4 min-h-[6rem]">
                    {participants.length > 0 ? participants.map(p => (
                        <span key={p.id} className="bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-4 py-2 rounded-full font-semibold">{p.name}</span>
                    )) : <p className="text-gray-500">Menunggu peserta bergabung...</p>}
                </div>
            </div>
            <button onClick={handleStartGame} disabled={participants.length === 0} className="mt-8 w-full bg-green-500 text-white py-4 rounded-lg text-xl font-bold hover:bg-green-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                Mulai Kuis!
            </button>
        </div>
    );
}

function PlayerLobby({ navigate, gameCode, nickname }) {
    const [participants, setParticipants] = useState([]);

    useEffect(() => {
        const sessionsRef = collection(db, `artifacts/${appId}/public/data/gameSessions`);
        const q = query(sessionsRef, where("gameCode", "==", gameCode));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            if (!querySnapshot.empty) {
                const sessionDoc = querySnapshot.docs[0];
                const data = sessionDoc.data();
                setParticipants(data.participants || []);
                if (data.status === 'in-progress') {
                    navigate('playerGame');
                }
            } else {
                // Game session might have been deleted or code is wrong
                navigate('home');
            }
        });

        return () => unsubscribe();
    }, [gameCode, navigate]);

    return (
        <div className="text-center max-w-2xl mx-auto">
            <h1 className="text-4xl font-bold mb-4">Anda berhasil bergabung!</h1>
            <p className="text-lg text-gray-600 dark:text-gray-400 mb-8">Selamat datang, <span className="font-bold text-indigo-600 dark:text-indigo-400">{nickname}</span>! Tunggu pembuat kuis memulai permainan.</p>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 className="text-2xl font-bold mb-4">Peserta Lain ({participants.length})</h2>
                <div className="flex flex-wrap justify-center gap-4 min-h-[6rem]">
                    {participants.map(p => (
                        <span key={p.id} className={`px-4 py-2 rounded-full font-semibold ${p.name === nickname ? 'bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-100' : 'bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200'}`}>{p.name}</span>
                    ))}
                </div>
            </div>
        </div>
    );
}

function GameHostView({ navigate, sessionData }) {
    const [quiz, setQuiz] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchQuiz = async () => {
            if (sessionData) {
                const quizDoc = await getDoc(doc(db, `artifacts/${appId}/users/${sessionData.hostId}/quizzes`, sessionData.quizId));
                if (quizDoc.exists()) {
                    setQuiz(quizDoc.data());
                }
                setLoading(false);
            }
        };
        fetchQuiz();
    }, [sessionData]);

    const handleNextQuestion = async () => {
        const nextIndex = sessionData.currentQuestionIndex + 1;
        const sessionsRef = collection(db, `artifacts/${appId}/public/data/gameSessions`);
        const q = query(sessionsRef, where("gameCode", "==", sessionData.gameCode));
        const querySnapshot = await getDocs(q);
        if(!querySnapshot.empty) {
            const sessionDocRef = querySnapshot.docs[0].ref;
            if (nextIndex < quiz.questions.length) {
                await updateDoc(sessionDocRef, { currentQuestionIndex: nextIndex });
            } else {
                await updateDoc(sessionDocRef, { status: 'finished' });
                navigate('results');
            }
        }
    };

    if (loading || !quiz) return <div className="text-center p-10">Memuat pertanyaan...</div>;
    
    const currentQuestion = quiz.questions[sessionData.currentQuestionIndex];

    return (
        <div className="max-w-4xl mx-auto text-center">
            <h2 className="text-2xl font-semibold mb-2">Pertanyaan {sessionData.currentQuestionIndex + 1} dari {quiz.questions.length}</h2>
            <p className="text-3xl font-bold p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">{currentQuestion.text}</p>
            <button onClick={handleNextQuestion} className="mt-8 w-full bg-indigo-600 text-white py-4 rounded-lg text-xl font-bold hover:bg-indigo-700 transition">
                {sessionData.currentQuestionIndex + 1 < quiz.questions.length ? 'Pertanyaan Berikutnya' : 'Lihat Hasil'}
            </button>
        </div>
    );
}

function PlayerGameView({ navigate, gameCode, nickname }) {
    const [session, setSession] = useState(null);
    const [quiz, setQuiz] = useState(null);
    const [currentQuestion, setCurrentQuestion] = useState(null);
    const [selectedAnswer, setSelectedAnswer] = useState(null);
    const [answered, setAnswered] = useState(false);

    useEffect(() => {
        const sessionsRef = collection(db, `artifacts/${appId}/public/data/gameSessions`);
        const q = query(sessionsRef, where("gameCode", "==", gameCode));
        const unsubscribe = onSnapshot(q, async (querySnapshot) => {
            if (!querySnapshot.empty) {
                const sessionDoc = querySnapshot.docs[0];
                const sessionData = sessionDoc.data();
                setSession(sessionData);

                if (sessionData.status === 'finished') {
                    navigate('playerResult');
                    return;
                }

                if (!quiz) {
                    const quizDoc = await getDoc(doc(db, `artifacts/${appId}/users/${sessionData.hostId}/quizzes`, sessionData.quizId));
                    if (quizDoc.exists()) {
                        setQuiz(quizDoc.data());
                    }
                }
                setSelectedAnswer(null);
                setAnswered(false);
            }
        });
        return () => unsubscribe();
    }, [gameCode, quiz, navigate]);

    useEffect(() => {
        if (quiz && session) {
            setCurrentQuestion(quiz.questions[session.currentQuestionIndex]);
        }
    }, [quiz, session]);

    const handleAnswer = async (answerIndex) => {
        if (answered) return;
        setSelectedAnswer(answerIndex);
        setAnswered(true);

        // Here you would normally save the answer to Firestore.
        // For simplicity in this prototype, we'll just show feedback.
    };

    if (!currentQuestion || !session) return <div className="text-center p-10">Menunggu pertanyaan berikutnya...</div>;
    
    const isCorrect = selectedAnswer === currentQuestion.correctAnswer;

    return (
        <div className="max-w-4xl mx-auto text-center">
            <div className="flex justify-between items-center mb-4">
                <span className="text-lg font-semibold">Pertanyaan {session.currentQuestionIndex + 1}</span>
                <span className="text-lg font-semibold">Skor: 0</span>
            </div>
            <div className="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg mb-6 min-h-[10rem] flex items-center justify-center">
                <h2 className="text-3xl font-bold">{currentQuestion.text}</h2>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {currentQuestion.options.map((option, index) => (
                    <button 
                        key={index}
                        onClick={() => handleAnswer(index)}
                        disabled={answered}
                        className={`p-6 rounded-lg text-xl font-semibold transition duration-300 w-full text-left
                            ${!answered ? 'bg-indigo-500 hover:bg-indigo-600 text-white' : ''}
                            ${answered && index === currentQuestion.correctAnswer ? 'bg-green-500 text-white' : ''}
                            ${answered && index !== currentQuestion.correctAnswer && index === selectedAnswer ? 'bg-red-500 text-white' : ''}
                            ${answered && index !== currentQuestion.correctAnswer && index !== selectedAnswer ? 'bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 opacity-70' : ''}
                        `}
                    >
                        {option}
                    </button>
                ))}
            </div>
            {answered && (
                <div className="mt-6 text-2xl font-bold">
                    {isCorrect ? <p className="text-green-500">Jawaban Benar!</p> : <p className="text-red-500">Jawaban Salah!</p>}
                </div>
            )}
        </div>
    );
}


function ResultsHostView({ navigate, sessionData }) {
    // In a real app, you would fetch all answers for the session and calculate scores.
    // For this prototype, we'll just show the participants.
    return (
        <div className="max-w-2xl mx-auto text-center">
            <h1 className="text-4xl font-bold mb-6">Hasil Kuis</h1>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 className="text-2xl font-bold mb-4">Papan Peringkat</h2>
                <ul className="space-y-3 text-left">
                    {sessionData?.participants.sort((a, b) => b.score - a.score).map((p, index) => (
                        <li key={p.id} className="flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <span className="font-bold text-lg">{index + 1}. {p.name}</span>
                            <span className="font-semibold text-indigo-600 dark:text-indigo-400">{p.score} poin</span>
                        </li>
                    ))}
                </ul>
            </div>
            <button onClick={() => navigate('dashboard')} className="mt-8 bg-indigo-600 text-white py-3 px-8 rounded-lg hover:bg-indigo-700 transition">
                Kembali ke Dashboard
            </button>
        </div>
    );
}

function PlayerResultView({ navigate, gameCode, nickname }) {
    const [session, setSession] = useState(null);

    useEffect(() => {
        const fetchSession = async () => {
             const sessionsRef = collection(db, `artifacts/${appId}/public/data/gameSessions`);
             const q = query(sessionsRef, where("gameCode", "==", gameCode));
             const querySnapshot = await getDocs(q);
             if (!querySnapshot.empty) {
                 setSession(querySnapshot.docs[0].data());
             }
        };
        fetchSession();
    }, [gameCode]);

    if (!session) return <div className="text-center p-10">Memuat hasil...</div>;

    const myRank = session.participants.sort((a, b) => b.score - a.score).findIndex(p => p.name === nickname) + 1;
    const myScore = session.participants.find(p => p.name === nickname)?.score || 0;

    return (
        <div className="max-w-2xl mx-auto text-center">
            <h1 className="text-4xl font-bold mb-4">Permainan Selesai!</h1>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h2 className="text-2xl font-semibold">Peringkat Anda: <span className="text-indigo-500 font-bold">#{myRank}</span></h2>
                <p className="text-xl">Skor Akhir: <span className="text-indigo-500 font-bold">{myScore}</span> poin</p>
            </div>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 className="text-2xl font-bold mb-4">Papan Peringkat Akhir</h2>
                <ul className="space-y-3 text-left">
                    {session.participants.sort((a, b) => b.score - a.score).map((p, index) => (
                        <li key={p.id} className={`flex items-center justify-between p-3 rounded-lg ${p.name === nickname ? 'bg-green-100 dark:bg-green-900' : 'bg-gray-100 dark:bg-gray-700'}`}>
                            <span className="font-bold text-lg">{index + 1}. {p.name}</span>
                            <span className="font-semibold text-indigo-600 dark:text-indigo-400">{p.score} poin</span>
                        </li>
                    ))}
                </ul>
            </div>
            <button onClick={() => navigate('home')} className="mt-8 bg-indigo-600 text-white py-3 px-8 rounded-lg hover:bg-indigo-700 transition">
                Main Lagi
            </button>
        </div>
    );
}
